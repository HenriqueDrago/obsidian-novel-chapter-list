/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var I=Object.defineProperty;var M=Object.getOwnPropertyDescriptor;var B=Object.getOwnPropertyNames;var H=Object.prototype.hasOwnProperty;var R=(p,e)=>{for(var t in e)I(p,t,{get:e[t],enumerable:!0})},W=(p,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of B(e))!H.call(p,s)&&s!==t&&I(p,s,{get:()=>e[s],enumerable:!(n=M(e,s))||n.enumerable});return p};var _=p=>W(I({},"__esModule",{value:!0}),p);var Y={};R(Y,{default:()=>j});module.exports=_(Y);var a=require("obsidian");var g=require("obsidian"),v={novelProjects:[{id:`default-${Date.now()}`,name:"My First Novel",path:"Novel/Chapters"}],propertyNameToChange:"status",propertyColumnHeader:"",propertyOptions:"To Do,In Progress,Drafted,Revised,Done",chapterTemplatePath:""};function z(){return`novel-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}var N=class extends g.PluginSettingTab{constructor(e,t){super(e,t),this.plugin=t}display(){let{containerEl:e}=this;e.empty(),e.createEl("h2",{text:"Novel Chapter Plugin Settings"}),e.createEl("h3",{text:"Chapter Properties & Template"}),new g.Setting(e).setName("Target Property Name").setDesc('The actual frontmatter key to update (e.g., "status", "outlineLevel"). This is case-sensitive.').addText(n=>n.setPlaceholder(v.propertyNameToChange).setValue(this.plugin.settings.propertyNameToChange).onChange(async s=>{this.plugin.settings.propertyNameToChange=s.trim(),await this.plugin.saveSettings(),this.plugin.refreshNovelChapterView()})),new g.Setting(e).setName("Property Column Header Display Name").setDesc('What title to display for the property column in the view (e.g., "Current Status"). If empty, it will use the "Target Property Name".').addText(n=>n.setPlaceholder("e.g., Status (optional)").setValue(this.plugin.settings.propertyColumnHeader).onChange(async s=>{this.plugin.settings.propertyColumnHeader=s.trim(),await this.plugin.saveSettings(),this.plugin.refreshNovelChapterView()})),new g.Setting(e).setName("Property Options").setDesc('Enter a comma-separated list of options for the dropdown (e.g., "To Do,In Progress,Complete").').addText(n=>n.setPlaceholder(v.propertyOptions).setValue(this.plugin.settings.propertyOptions).onChange(async s=>{this.plugin.settings.propertyOptions=s,await this.plugin.saveSettings(),this.plugin.refreshNovelChapterView()})),new g.Setting(e).setName("Chapter Template File Path").setDesc('Path to a markdown file to use as a template for new chapters (e.g., "Templates/ChapterTemplate.md"). Leave empty to not use a template. Placeholders like {{title}} and {{date}} can be used in the template.').addText(n=>n.setPlaceholder(v.chapterTemplatePath||"e.g., Templates/ChapterTemplate.md").setValue(this.plugin.settings.chapterTemplatePath).onChange(async s=>{this.plugin.settings.chapterTemplatePath=s.trim(),await this.plugin.saveSettings()})),e.createEl("hr"),e.createEl("h3",{text:"Novel Projects"});let t=e.createDiv({cls:"novel-projects-container"});this.renderNovelProjects(t),new g.Setting(e).setName("Add New Novel Project").setDesc("Add a new novel to track.").addButton(n=>n.setButtonText("Add Novel").setCta().onClick(async()=>{this.plugin.settings.novelProjects.push({id:z(),name:`New Novel ${this.plugin.settings.novelProjects.length+1}`,path:""}),await this.plugin.saveSettings(),this.renderNovelProjects(t),this.plugin.refreshNovelChapterView(!0)}))}renderNovelProjects(e){e.empty(),this.plugin.settings.novelProjects.length===0&&e.createEl("p",{text:"No novel projects configured. Add one below."}),this.plugin.settings.novelProjects.forEach((t,n)=>{let s=new g.Setting(e).setName(`Novel ${n+1}`).setDesc(`Configuration for ${t.name||"this novel"}.`);s.addText(i=>i.setPlaceholder("Novel Name (e.g., My Epic Saga)").setValue(t.name).onChange(async l=>{t.name=l.trim(),await this.plugin.saveSettings(),this.plugin.refreshNovelChapterView(!0)})),s.addText(i=>i.setPlaceholder("Folder Path (e.g., Novels/MyEpicSaga/Chapters)").setValue(t.path).onChange(async l=>{t.path=l.trim(),await this.plugin.saveSettings(),this.plugin.refreshNovelChapterView(!0)})),s.addButton(i=>i.setIcon("trash").setTooltip("Remove this novel project").onClick(async()=>{this.plugin.settings.novelProjects.splice(n,1),await this.plugin.saveSettings(),this.renderNovelProjects(e),this.plugin.refreshNovelChapterView(!0)}))})}};var f="novel-chapter-view",U={...v,lastSelectedNovelId:null,novelProjects:Array.isArray(v.novelProjects)&&v.novelProjects.length>0?v.novelProjects:[{id:`default-${Date.now()}`,name:"My First Novel",path:"Novel/Chapters"}]};function D(p,e){if(!e||e.trim()==="")return!1;let t=(0,a.normalizePath)(p.path),n=(0,a.normalizePath)(e);return n.endsWith("/")||(n+="/"),t.startsWith(n)}var G=p=>new Promise(e=>setTimeout(e,p)),V=class extends a.Modal{constructor(t,n,s){super(t);this.message=n;this.onConfirm=s}onOpen(){let{contentEl:t}=this;t.empty(),t.addClass("confirm-modal"),t.createEl("p",{text:this.message});let n=t.createDiv({cls:"modal-button-container"});new a.ButtonComponent(n).setButtonText("Confirm").setWarning().onClick(()=>{this.onConfirm(),this.close()}),new a.ButtonComponent(n).setButtonText("Cancel").onClick(()=>{this.close()})}onClose(){this.contentEl.empty()}},T=class extends a.Modal{constructor(t,n,s,i,l){super(t);this.result=null;this.modalTitle=n,this.ctaButtonText=s,this.initialValue=i,this.onSubmit=l}onOpen(){let{contentEl:t}=this;t.empty(),t.createEl("h2",{text:this.modalTitle});let n=t.createDiv({cls:"modal-input-container"}),s=new a.TextComponent(n).setPlaceholder("Chapter name").setValue(this.initialValue);s.inputEl.addClass("modal-text-input"),s.inputEl.focus();let i=t.createDiv({cls:"modal-button-container"}),l=new a.ButtonComponent(i).setButtonText(this.ctaButtonText).setCta(),h=()=>{let r=s.getValue().trim();r?(this.result=r,this.close(),this.onSubmit(this.result)):new a.Notice("Chapter name cannot be empty.")};l.onClick(h),new a.ButtonComponent(i).setButtonText("Cancel").onClick(()=>this.close()),s.inputEl.addEventListener("keypress",r=>{r.key==="Enter"&&(r.preventDefault(),h())})}onClose(){this.contentEl.empty()}},y=class extends a.ItemView{constructor(t,n){super(t);this.selectedNovelProjectId=null;this.searchTerm="";this.filterValue="all";this.plugin=n}getViewType(){return f}getDisplayText(){let t=this.plugin.settings.novelProjects.find(n=>n.id===this.selectedNovelProjectId);return t?`Chapters: ${t.name}`:"Novel Chapters"}getIcon(){return"list-ordered"}async onOpen(){let t=this.containerEl.children[1];t.empty(),t.addClass("novel-chapter-view-container"),this.controlsContainer=t.createDiv({cls:"novel-chapter-controls"}),this.tableContainer=t.createDiv({cls:"novel-chapter-table-container"}),await this.updateView(!0)}async onClose(){}async updateView(t=!1){if(t&&await this.renderControls(),!this.selectedNovelProjectId||!this.plugin.settings.novelProjects.find(n=>n.id===this.selectedNovelProjectId)){this.plugin.settings.lastSelectedNovelId&&this.plugin.settings.novelProjects.find(s=>s.id===this.plugin.settings.lastSelectedNovelId)?this.selectedNovelProjectId=this.plugin.settings.lastSelectedNovelId:this.plugin.settings.novelProjects.length>0?this.selectedNovelProjectId=this.plugin.settings.novelProjects[0].id:this.selectedNovelProjectId=null;let n=this.controlsContainer.querySelector("select.novel-project-selector");n&&this.selectedNovelProjectId?n.value=this.selectedNovelProjectId:n&&!this.selectedNovelProjectId&&this.plugin.settings.novelProjects.length>0&&(n.value=this.plugin.settings.novelProjects[0].id)}this.updateLeafDisplayText(),await this.renderChapterTable()}updateLeafDisplayText(){this.leaf&&this.leaf.setViewState(this.leaf.getViewState())}async renderControls(){this.controlsContainer.empty();let t=this.plugin.settings.novelProjects;if(t.length===0){this.controlsContainer.setText("No novel projects configured. Please add one in plugin settings."),this.selectedNovelProjectId=null;return}let n=this.controlsContainer.createDiv({cls:"novel-chapter-controls-line"}),s=this.controlsContainer.createDiv({cls:"novel-chapter-controls-line"}),i=n.createEl("select");i.addClass("novel-project-selector"),t.forEach(r=>{i.createEl("option",{text:r.name||"Unnamed Novel",value:r.id})}),this.selectedNovelProjectId&&t.find(r=>r.id===this.selectedNovelProjectId)?i.value=this.selectedNovelProjectId:t.length>0&&(this.selectedNovelProjectId=t[0].id,i.value=this.selectedNovelProjectId),i.addEventListener("change",async r=>{this.selectedNovelProjectId=r.target.value,this.plugin.settings.lastSelectedNovelId=this.selectedNovelProjectId,await this.plugin.saveSettings(),this.updateLeafDisplayText(),await this.renderChapterTable()}),n.createEl("button",{text:"\uFF0B New Chapter",cls:"novel-chapter-new-button"}).addEventListener("click",async()=>{await this.plugin.promptAndCreateNewChapter(this.selectedNovelProjectId)}),new a.TextComponent(s).setPlaceholder("Search chapters...").setValue(this.searchTerm).onChange(r=>{this.searchTerm=r,this.renderChapterTable()}).inputEl.addClass("novel-chapter-search-input");let{propertyOptions:l}=this.plugin.settings,h=l.split(",").map(r=>r.trim()).filter(r=>r.length>0);if(h.length>0){let r=s.createEl("select");r.addClass("novel-chapter-filter-select"),r.createEl("option",{text:"Filter by property...",value:"all"}),h.forEach(c=>{r.createEl("option",{text:c,value:c})}),r.value=this.filterValue,r.addEventListener("change",c=>{this.filterValue=c.target.value,this.renderChapterTable()})}}async renderChapterTable(){var m;if(this.tableContainer.empty(),!this.selectedNovelProjectId)return;let t=this.plugin.settings.novelProjects.find(o=>o.id===this.selectedNovelProjectId);if(!t){this.tableContainer.setText("Selected novel project not found.");return}let{path:n}=t,{propertyNameToChange:s,propertyColumnHeader:i,propertyOptions:l}=this.plugin.settings,h=l.split(",").map(o=>o.trim()).filter(o=>o.length>0);if(!n||n.trim()===""){this.tableContainer.setText(`Project "${t.name}" has no folder path configured.`);return}let c=this.app.vault.getMarkdownFiles().filter(o=>D(o,n));if(this.filterValue!=="all"&&(c=c.filter(o=>{var E;let u=this.app.metadataCache.getFileCache(o);return((E=u==null?void 0:u.frontmatter)==null?void 0:E[s])===this.filterValue})),this.searchTerm&&(c=c.filter(o=>o.basename.toLowerCase().includes(this.searchTerm.toLowerCase()))),c.sort((o,u)=>o.path.localeCompare(u.path)),c.length===0){this.tableContainer.setText(`No chapters found in "${n}" matching your criteria.`);return}let C=this.tableContainer.createEl("table",{cls:"novel-chapter-table"}),d=C.createEl("thead").createEl("tr");if(d.createEl("th",{text:`Chapter (${c.length})`}),s&&h.length>0){let o=i.trim()||s;d.createEl("th",{text:o})}d.createEl("th",{text:"Actions"}).addClass("actions-header");let w=C.createEl("tbody");for(let o of c){let u=w.createEl("tr");if(u.createEl("td").createEl("a",{text:o.basename,href:"#",cls:"internal-link"}).addEventListener("click",L=>{L.preventDefault(),this.app.workspace.openLinkText(o.path,"",!1)}),s&&h.length>0){let x=u.createEl("td").createEl("select"),b=this.app.metadataCache.getFileCache(o),$=((m=b==null?void 0:b.frontmatter)==null?void 0:m[s])||"",O=x.createEl("option",{text:"--- Select ---",value:""});$||(O.selected=!0),h.forEach(P=>{let F=x.createEl("option",{text:P,value:P});P===$&&(F.selected=!0)}),x.addEventListener("change",async P=>{let F=P.target.value;await this.plugin.updateChapterProperty(o,s,F)})}let S=u.createEl("td");S.addClass("actions-cell"),new a.ButtonComponent(S).setIcon("pencil").setTooltip("Rename chapter").onClick(()=>{this.plugin.promptAndRenameChapter(o)}).buttonEl.addClass("action-button");let k=new a.ButtonComponent(S).setIcon("trash").setTooltip("Delete chapter").onClick(()=>{this.plugin.promptAndDeleteChapter(o)});k.buttonEl.addClass("action-button"),k.buttonEl.addClass("delete-button")}}},j=class extends a.Plugin{getProjectChapters(e){if(!e||e.trim()==="")return[];let n=this.app.vault.getMarkdownFiles().filter(s=>D(s,e));return n.sort((s,i)=>s.path.localeCompare(i.path)),n}findProjectForFile(e){return e&&this.settings.novelProjects.find(t=>t.path&&D(e,t.path))||null}async updateChapterProperty(e,t,n){try{await this.app.fileManager.processFrontMatter(e,s=>{n===""?delete s[t]:s[t]=n}),new a.Notice(`Chapter '${e.basename}' ${t} updated.`)}catch(s){console.error(`Error updating frontmatter for ${e.path}:`,s),new a.Notice(`Failed to update ${t} for ${e.basename}.`)}}async promptAndRenameChapter(e){let t=e.basename;new T(this.app,"Rename Chapter","Rename",t,async n=>{n&&n!==t&&await this.renameChapter(e,n)}).open()}async renameChapter(e,t){let n=t.replace(/[\\/:*?"<>|]/g,"").trim();if(n===""){new a.Notice("Invalid chapter name provided.");return}if(!e.parent){new a.Notice("Cannot rename file: No parent folder found."),console.error("Could not find parent for file:",e.path);return}let s=`${e.parent.path}/${n}.md`;if(await this.app.vault.adapter.exists((0,a.normalizePath)(s))){new a.Notice(`A chapter named "${n}.md" already exists.`);return}try{await this.app.fileManager.renameFile(e,s),new a.Notice(`Chapter renamed to "${n}".`)}catch(i){console.error("Error renaming file:",i),new a.Notice("Failed to rename chapter. See console for details.")}}async promptAndDeleteChapter(e){new V(this.app,`Are you sure you want to delete "${e.basename}"? This will move the file to the trash.`,async()=>await this.deleteChapter(e)).open()}async deleteChapter(e){try{await this.app.vault.trash(e,!0),new a.Notice(`Chapter "${e.basename}" moved to trash.`)}catch(t){console.error("Error deleting file:",t),new a.Notice("Failed to delete chapter. See console for details.")}}async promptAndCreateNewChapter(e){var n;if(!e){new a.Notice("Please select a novel project first.");return}let t=this.settings.novelProjects.find(s=>s.id===e);if(!t||!((n=t.path)!=null&&n.trim())){new a.Notice("The selected project does not have a valid folder path configured.");return}new T(this.app,"Enter New Chapter Name","Create Chapter","",async s=>{var C;let i=s.replace(/[\\/:*?"<>|]/g,"").trim();if(i===""){new a.Notice("Invalid chapter name.");return}let l=(0,a.normalizePath)(t.path);if(!await this.app.vault.adapter.exists(l)){new a.Notice(`Project folder "${l}" does not exist.`);return}let h=(0,a.normalizePath)(`${l}/${i}.md`);if(await this.app.vault.adapter.exists(h)){new a.Notice(`A chapter named "${i}.md" already exists.`);return}let r="",c=(C=this.settings.chapterTemplatePath)==null?void 0:C.trim();if(c){let d=(0,a.normalizePath)(c),w=this.app.vault.getAbstractFileByPath(d);if(w instanceof a.TFile){r=await this.app.vault.read(w);let m=new Date,o=`${m.getFullYear()}-${String(m.getMonth()+1).padStart(2,"0")}-${String(m.getDate()).padStart(2,"0")}`;r=r.replace(/\{\{title\}\}/gi,s),r=r.replace(/\{\{date\}\}/gi,o)}else new a.Notice(`Template file not found at "${c}". Creating a default chapter.`)}if(r===""){let{propertyNameToChange:d}=this.settings;r=`---
title: ${s}
`,d&&(r+=`${d}: ""
`),r+=`---

# ${s}

`}try{await this.app.vault.create(h,r),new a.Notice(`Chapter "${s}" created successfully.`)}catch(d){console.error("Error creating new chapter:",d),new a.Notice("Failed to create new chapter. Check console for details.")}}).open()}async onload(){console.log("Novel Chapter Plugin loaded"),await this.loadSettings(),this.addSettingTab(new N(this.app,this)),this.registerView(f,e=>new y(e,this)),this.addCommand({id:"open-novel-chapter-view",name:"Open Novel Chapter View",callback:()=>this.activateView()}),this.addCommand({id:"add-new-chapter-to-project",name:"Novel Chapters: Create New Chapter in Project",callback:()=>{let e=this.settings.lastSelectedNovelId;if(!e&&this.settings.novelProjects.length===1&&(e=this.settings.novelProjects[0].id),!e){new a.Notice("Cannot determine project. Please select a project in the Novel Chapters view.");return}this.promptAndCreateNewChapter(e)}}),this.addCommand({id:"open-next-chapter-in-project",name:"Novel Chapters: Open Next Chapter",checkCallback:e=>{let t=this.app.workspace.getActiveFile();if(!t)return!1;let n=this.findProjectForFile(t);if(!n)return!1;if(e)return!0;let s=this.getProjectChapters(n.path),i=s.findIndex(l=>l.path===t.path);i!==-1&&i<s.length-1?this.app.workspace.openLinkText(s[i+1].path,"",!1):new a.Notice("This is the last chapter.")}}),this.addCommand({id:"open-previous-chapter-in-project",name:"Novel Chapters: Open Previous Chapter",checkCallback:e=>{let t=this.app.workspace.getActiveFile();if(!t)return!1;let n=this.findProjectForFile(t);if(!n)return!1;if(e)return!0;let s=this.getProjectChapters(n.path),i=s.findIndex(l=>l.path===t.path);i>0?this.app.workspace.openLinkText(s[i-1].path,"",!1):new a.Notice("This is the first chapter.")}}),this.addRibbonIcon("list-ordered","Open Novel Chapter View",()=>this.activateView()),this.registerEvent(this.app.vault.on("create",e=>this.handleFileChange(e))),this.registerEvent(this.app.vault.on("modify",e=>this.handleFileChange(e))),this.registerEvent(this.app.vault.on("delete",e=>this.handleFileChange(e))),this.registerEvent(this.app.vault.on("rename",(e,t)=>this.handleFileChange(e,t)))}onunload(){console.log("Novel Chapter Plugin unloaded"),this.app.workspace.detachLeavesOfType(f)}async loadSettings(){this.settings=Object.assign({},U,await this.loadData()),(!Array.isArray(this.settings.novelProjects)||this.settings.novelProjects.length===0)&&(this.settings.novelProjects=[{id:`default-load-${Date.now()}`,name:"Default Novel",path:""}]),this.settings.novelProjects=this.settings.novelProjects.map(e=>({id:e.id||`generated-${Date.now()}`,name:e.name||"Unnamed Novel",path:e.path||""})),this.settings.lastSelectedNovelId&&!this.settings.novelProjects.find(e=>e.id===this.settings.lastSelectedNovelId)&&(this.settings.lastSelectedNovelId=this.settings.novelProjects.length>0?this.settings.novelProjects[0].id:null)}async saveSettings(){await this.saveData(this.settings),this.refreshNovelChapterView(!0)}refreshNovelChapterView(e=!1){this.app.workspace.getLeavesOfType(f).forEach(t=>{t.view instanceof y&&t.view.updateView(e)})}async handleFileChange(e,t){if(!(e instanceof a.TFile)||e.extension!=="md")return;this.settings.novelProjects.some(s=>{if(!s.path)return!1;let i=(0,a.normalizePath)(s.path),l=(0,a.normalizePath)(e.path).startsWith(i+"/"),h=t?(0,a.normalizePath)(t).startsWith(i+"/"):!1;return l||h})&&(await G(150),this.refreshNovelChapterView(!1))}async activateView(){var n;let{workspace:e}=this.app,t=e.getLeavesOfType(f)[0];t||(t=(n=e.getRightLeaf(!1))!=null?n:e.getLeaf("split","vertical"),await t.setViewState({type:f,active:!0})),e.revealLeaf(t)}};
